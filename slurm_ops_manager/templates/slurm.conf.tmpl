# slurm.conf file generated by Juju.

# active controller
{% if active_controller_hostname %}
ControlMachine={{ active_controller_hostname }}
ControlAddr={{ active_controller_ingress_address }}
{% elif active_controller_ingress_address %}
ControlMachine={{ active_controller_ingress_address }}
ControlAddr={{ active_controller_ingress_address }}
{% endif %}

# backup controller
{% if backup_controller_hostname %}
BackupController={{ backup_controller_hostname }}
BackupAddr={{ backup_controller_ingress_address }}
{% elif backup_controller_ingress_address %}
BackupController={{ backup_controller_ingress_address }}
BackupAddr={{ backup_controller_ingress_address }}
{% endif %}

AuthType=auth/munge
AuthInfo="socket=/var/snap/munge/current/munged.socket.2"
CryptoType=crypto/munge
MailProg=/usr/bin/mail 
MpiDefault={{ mpi_default }}

# TODO: Add support for cgroup
ProctrackType=proctrack/linuxproc
ReturnToService=1
SlurmctldPidFile=/var/run/slurmctld.pid
SlurmctldPort={{ active_controller_port }} 
SlurmdPidFile=/var/run/slurmd.pid
SlurmdPort=6818
SlurmdSpoolDir=/var/spool/slurmd
SlurmUser=slurm
StateSaveLocation=/var/lib/slurmd
TaskPlugin=task/none

PluginDir=/var/lib/slurmd

# TIMERS 
KillWait={{ kill_wait }} 
MinJobAge={{ min_job_age }} 
SlurmctldTimeout={{ slurmctld_timeout }} 
SlurmdTimeout={{ slurmd_timeout }} 

# SCHEDULING 
FastSchedule=1
SchedulerType={{ scheduler_type }}
SelectType={{  select_type }}
{% if select_type == "select/cons_res" -%}
SelectTypeParameters={{ select_type_parameters }}
{% endif %}

# LOGGING AND ACCOUNTING 
ClusterName={{ clustername }}

# SLURMDBD CONFIGURED ON {{ slurmdbd_hostname }}
AccountingStorageType=accounting_storage/slurmdbd
JobAcctGatherType=jobacct_gather/linux
AccountingStorageHost={{ slurmdbd_hostname }}
AccountingStoragePort={{ slurmdbd_port }}
AccountingStoragePass="/var/snap/munge/current/munged.socket.2"

JobAcctGatherFrequency=30 
SlurmctldDebug={{ slurmctld_debug }} 
SlurmctldLogFile=/var/log/slurm/slurmctld.log
SlurmdDebug={{ slurmd_debug }} 
SlurmdLogFile=/var/log/slurm/slurmd.log

# INCLUDE CLUSTER SPECIFIC CONFIGURATION OVERRIDE
#include /etc/slurm/slurm-%c.conf

#GRES type
GresTypes=gpu 

# COMPUTE NODES 
{% for node in nodes %}
NodeName={{ node.hostname }} NodeAddr={{ node.ingress_address }} State=UNKNOWN Boards={{ node.inventory.Boards }} SocketsPerBoard={{ node.inventory.SocketsPerBoard }} CoresPerSocket={{ node.inventory.CoresPerSocket }} ThreadsPerCore={{ node.inventory.ThreadsPerCore }} RealMemory={{ node.inventory.RealMemory }}
{%- endfor -%}
{% for partition, values in partitions.items() %}
PartitionName={{ partition }} Nodes={{ values.hosts|join(',') }} Default={{ 'YES' if values.default else 'NO' }} State=UP
{% endfor %}
